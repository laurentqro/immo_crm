<%= form_with model: client, local: true, data: { controller: "client-form" } do |form| %>
  <%= render "application/error_messages", resource: client %>

  <div class="space-y-6">
    <%# Basic Information %>
    <div class="form-group">
      <%= form.label :name %>
      <%= form.text_field :name, required: true, class: "form-control" %>
    </div>

    <%# Client Type as Radio Buttons %>
    <fieldset class="form-group">
      <legend class="form-label">Client type <span class="text-red-500">*</span></legend>
      <div class="flex gap-6 mt-2">
        <% [["Natural Person", "NATURAL_PERSON"], ["Legal Entity", "LEGAL_ENTITY"], ["Trust", "TRUST"]].each do |label, value| %>
          <label class="flex items-center gap-2 cursor-pointer">
            <%= form.radio_button :client_type, value,
                data: { client_form_target: "clientType", action: "change->client-form#toggleFields" },
                class: "form-radio" %>
            <span><%= label %></span>
          </label>
        <% end %>
      </div>
    </fieldset>

    <%# Legal Person Type (only for Legal Entity) %>
    <div class="form-group <%= 'hidden' unless client.legal_entity? %>" data-client-form-target="legalPersonType">
      <%= form.label :legal_person_type, "Legal form" %>
      <%= form.select :legal_person_type,
          options_for_select([
            ["SCI (Société Civile Immobilière)", "SCI"],
            ["SARL (Société à Responsabilité Limitée)", "SARL"],
            ["SAM (Société Anonyme Monégasque)", "SAM"],
            ["SNC (Société en Nom Collectif)", "SNC"],
            ["SA (Société Anonyme)", "SA"],
            ["Other", "OTHER"]
          ], client.legal_person_type),
          { include_blank: "Select legal form..." } %>
    </div>

    <%# Trustee Section (only for Trust) %>
    <div class="<%= 'hidden' unless client.trust? %>" data-client-form-target="trusteeSection">
      <div class="border rounded-lg p-4 mb-2" style="border-color: var(--base-border-tertiary); background-color: var(--base-bg-secondary)">
        <h3 class="text-sm font-medium mb-4">Trustee Information</h3>

        <div class="grid sm:grid-cols-2 gap-4">
          <div class="form-group">
            <%= form.label :trustee_name, "Trustee name" %>
            <%= form.text_field :trustee_name, class: "form-control" %>
          </div>

          <div class="form-group">
            <%= form.label :trustee_nationality, "Trustee nationality" %>
            <%= form.select :trustee_nationality,
                options_for_select(ISO3166::Country.all.map { |c| [c.iso_short_name, c.alpha2] }.sort, client.trustee_nationality),
                { include_blank: "Select country..." },
                { class: "form-control" } %>
          </div>

          <div class="form-group">
            <%= form.label :trustee_country, "Trustee country of residence" %>
            <%= form.select :trustee_country,
                options_for_select(ISO3166::Country.all.map { |c| [c.iso_short_name, c.alpha2] }.sort, client.trustee_country),
                { include_blank: "Select country..." },
                { class: "form-control" } %>
          </div>

          <div class="form-group flex items-end">
            <div class="form-picker-group">
              <%= form.check_box :is_professional_trustee %>
              <div>
                <%= form.label :is_professional_trustee, "Professional trustee" %>
                <p class="form-hint">Trustee acts in a professional capacity (lawyer, accountant, trust company)</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <div class="form-group">
        <%= form.label :nationality %>
        <%= form.select :nationality,
            options_for_select([
              ["Monaco", "MC"],
              ["France", "FR"],
              ["Italy", "IT"],
              ["Switzerland", "CH"],
              ["United Kingdom", "GB"],
              ["United States", "US"],
              ["Russia", "RU"],
              ["Other", ""]
            ], client.nationality),
            { include_blank: "Select country..." } %>
      </div>

      <div class="form-group">
        <%= form.label :residence_country, "Residence country" %>
        <%= form.select :residence_country,
            options_for_select([
              ["Monaco", "MC"],
              ["France", "FR"],
              ["Italy", "IT"],
              ["Switzerland", "CH"],
              ["United Kingdom", "GB"],
              ["United States", "US"],
              ["Russia", "RU"],
              ["Other", ""]
            ], client.residence_country),
            { include_blank: "Select country..." } %>
      </div>
    </div>

    <%# PEP Section %>
    <div class="border-t pt-6" style="border-color: var(--base-border-tertiary);">
      <div class="form-picker-group">
        <%= form.check_box :is_pep,
            data: { client_form_target: "isPep", action: "change->client-form#togglePepType" } %>
        <div>
          <%= form.label :is_pep, "Politically Exposed Person" %>
          <p class="form-hint">Client is a PEP or related to a PEP.</p>
        </div>
      </div>

      <div class="form-group mt-4 ml-7 <%= 'hidden' unless client.is_pep? %>" data-client-form-target="pepType">
        <%= form.label :pep_type, "PEP type" %>
        <%= form.select :pep_type,
            options_for_select([
              ["Domestic PEP", "DOMESTIC"],
              ["Foreign PEP", "FOREIGN"],
              ["International Organization", "INTL_ORG"]
            ], client.pep_type),
            { include_blank: "Select PEP type..." } %>
      </div>
    </div>

    <%# Risk Level %>
    <div class="form-group">
      <%= form.label :risk_level, "Risk level" %>
      <%= form.select :risk_level,
          options_for_select([
            ["Low", "LOW"],
            ["Medium", "MEDIUM"],
            ["High", "HIGH"]
          ], client.risk_level),
          { include_blank: "Select risk level..." } %>
    </div>

    <%# Due Diligence Section %>
    <div class="border-t pt-6" style="border-color: var(--base-border-tertiary);">
      <h3 class="text-sm font-medium mb-4" style="color: var(--base-text-secondary);">Due Diligence</h3>

      <div class="form-group">
        <%= form.label :due_diligence_level, "Due diligence level" %>
        <%= form.select :due_diligence_level,
            options_for_select([
              ["Standard", "STANDARD"],
              ["Simplified", "SIMPLIFIED"],
              ["Reinforced (Enhanced)", "REINFORCED"]
            ], client.due_diligence_level),
            { include_blank: "Select level..." },
            {
              data: {
                client_form_target: "dueDiligenceLevel",
                action: "change->client-form#toggleSimplifiedReason"
              }
            } %>
        <p class="form-hint">AMSF requirement: Standard for most clients, Simplified for low-risk regulated entities, Reinforced for high-risk or PEPs.</p>
      </div>

      <div class="form-group <%= 'hidden' unless client.due_diligence_level == 'SIMPLIFIED' %>" data-client-form-target="simplifiedDdReason">
        <%= form.label :simplified_dd_reason, "Simplified DD justification" %>
        <%= form.text_area :simplified_dd_reason,
            rows: 2,
            class: "form-control",
            placeholder: "Explain why simplified due diligence applies (e.g., regulated entity, low-risk profile)..." %>
        <p class="form-hint">Required when using simplified due diligence.</p>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mt-4">
        <div class="form-picker-group">
          <%= form.check_box :source_of_funds_verified %>
          <div>
            <%= form.label :source_of_funds_verified, "Source of funds verified" %>
            <p class="form-hint">Origin of funds for transactions has been documented.</p>
          </div>
        </div>

        <div class="form-picker-group">
          <%= form.check_box :source_of_wealth_verified %>
          <div>
            <%= form.label :source_of_wealth_verified, "Source of wealth verified" %>
            <p class="form-hint">Overall wealth origin has been documented.</p>
          </div>
        </div>
      </div>
    </div>

    <%# Professional Category %>
    <div class="form-group">
      <%= form.label :professional_category, "Professional category" %>
      <%= form.select :professional_category,
          options_for_select([
            ["Legal professional", "LEGAL"],
            ["Accountant", "ACCOUNTANT"],
            ["Notary", "NOTARY"],
            ["Real estate professional", "REAL_ESTATE"],
            ["Financial professional", "FINANCIAL"],
            ["Other regulated professional", "OTHER"],
            ["None / Not applicable", "NONE"]
          ], client.professional_category),
          { include_blank: "Select category..." } %>
      <p class="form-hint">If the client is a regulated professional subject to their own AML/CFT obligations.</p>
    </div>

    <%# Relationship End Section %>
    <div class="form-group">
      <%= form.label :relationship_end_reason, "Relationship end reason" %>
      <%= form.select :relationship_end_reason,
          options_for_select([
            ["Client request", "CLIENT_REQUEST"],
            ["AML/CFT concern", "AML_CONCERN"],
            ["Inactivity", "INACTIVITY"],
            ["Business decision", "BUSINESS_DECISION"],
            ["Other", "OTHER"]
          ], client.relationship_end_reason),
          { include_blank: "Still active client..." } %>
      <p class="form-hint">Reason for ending the business relationship (if applicable).</p>
    </div>

    <%# Business Sector (only for Legal Entity) %>
    <div class="form-group <%= 'hidden' unless client.legal_entity? %>" data-client-form-target="businessSector">
      <%= form.label :business_sector %>
      <%= form.text_field :business_sector,
          class: "form-control",
          placeholder: "e.g., Finance, Real Estate, Consulting" %>
    </div>

    <%# Became Client Date %>
    <div class="form-group">
      <%= form.label :became_client_at, "Client since" %>
      <%= form.date_field :became_client_at, class: "form-control" %>
    </div>

    <%# Notes %>
    <div class="form-group">
      <%= form.label :notes %>
      <%= form.text_area :notes,
          rows: 3,
          class: "form-control",
          placeholder: "Additional notes about this client..." %>
    </div>
  </div>

  <div class="mt-6 flex items-center justify-end gap-x-6">
    <%= link_to "Cancel", clients_path, class: "btn btn-secondary" %>
    <%= form.submit client.persisted? ? "Update Client" : "Create Client", class: "btn btn-primary" %>
  </div>
<% end %>
