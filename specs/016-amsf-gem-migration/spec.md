# Feature Specification: AMSF Survey Gem Migration

**Feature Branch**: `016-amsf-gem-migration`
**Created**: 2026-01-22
**Status**: Draft
**Input**: User description: "Migrate immo_crm XBRL code to amsf_survey gem"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Generate Valid XBRL Submissions (Priority: P1)

A compliance officer needs to generate AMSF survey submissions in valid XBRL format for regulatory filing. The system should produce XBRL documents using the new gem that are structurally identical to those produced by the current ad-hoc implementation.

**Why this priority**: This is the core regulatory requirement. Without valid XBRL output, the organization cannot meet AMSF compliance obligations. Every other feature depends on this working correctly.

**Independent Test**: Can be tested by generating an XBRL submission for a test organization and comparing it against a known-good reference output from the current system.

**Acceptance Scenarios**:

1. **Given** an organization with complete CRM data, **When** a submission is generated using the gem, **Then** the resulting XBRL document passes external Arelle validation
2. **Given** an organization with partial data, **When** a submission is generated, **Then** the XBRL document contains only the fields with available data and remains valid
3. **Given** a submission generated by the old system and one by the new gem for the same data, **When** comparing normalized XML, **Then** the semantic content is equivalent (same field values, contexts, and facts)

---

### User Story 2 - View Survey Questionnaire with Field Metadata (Priority: P2)

A compliance officer needs to view the AMSF survey questionnaire with accurate field labels, types, and section groupings to understand what data needs to be submitted and review current values.

**Why this priority**: Users need to understand the survey structure to verify data correctness. This enables the review workflow that precedes submission.

**Independent Test**: Can be tested by rendering the survey review page and verifying all 600+ fields display with correct labels, organized into proper sections.

**Acceptance Scenarios**:

1. **Given** a user viewing a submission, **When** the survey questionnaire loads, **Then** all fields are displayed with their French labels from the gem's taxonomy
2. **Given** a questionnaire with gate fields (fields that control visibility of other fields), **When** a gate field is set to "Non", **Then** the dependent fields are hidden from view
3. **Given** a submission with calculated values, **When** viewing the questionnaire, **Then** each field shows its current value and source (calculated, settings, or manual)

---

### User Story 3 - Validate Submissions Before Filing (Priority: P2)

A compliance officer needs to validate a submission against AMSF business rules before filing to catch errors early and reduce rejection risk.

**Why this priority**: Validation prevents costly rejections from the regulatory authority. Tied with P2 because it complements the review workflow.

**Independent Test**: Can be tested by validating a submission with known errors and verifying all errors are detected and reported with clear messages.

**Acceptance Scenarios**:

1. **Given** a submission with all required fields completed, **When** validation runs, **Then** the result indicates success with no errors
2. **Given** a submission missing required fields, **When** validation runs, **Then** specific error messages identify which fields are missing
3. **Given** a submission with calculation inconsistencies, **When** validation runs, **Then** errors identify the fields with mismatched totals
4. **Given** validation errors, **When** displayed to the user, **Then** messages are in French (matching AMSF context) unless English is explicitly configured

---

### User Story 4 - Calculate Survey Values from CRM Data (Priority: P3)

The system needs to automatically calculate survey field values from CRM data (clients, transactions, mandates) using existing business logic, but mapping to the gem's semantic field names.

**Why this priority**: Automation reduces manual data entry errors. Lower priority because manual override capability exists as a fallback.

**Independent Test**: Can be tested by running calculations for a test organization with known CRM data and verifying calculated values match expected results.

**Acceptance Scenarios**:

1. **Given** an organization with client records, **When** calculations run, **Then** client counts by nationality (Monegasque, foreign resident, non-resident) are correctly computed
2. **Given** an organization with transactions, **When** calculations run, **Then** transaction volumes and fund transfers are correctly aggregated
3. **Given** calculated values that differ from manually overridden values, **When** reviewing the submission, **Then** both values are shown with their sources clearly indicated

---

### User Story 5 - Multi-Year Taxonomy Support (Priority: P3)

The system needs to support different taxonomy versions by year (starting with 2025), allowing submissions to be generated for the correct regulatory year.

**Why this priority**: Required for ongoing compliance but not blocking initial migration. The gem supports this natively.

**Independent Test**: Can be tested by loading the questionnaire for year 2025 and verifying it returns the correct field count and structure.

**Acceptance Scenarios**:

1. **Given** a request for the 2025 questionnaire, **When** loaded from the gem, **Then** all 600+ fields are available with correct metadata
2. **Given** a future year (e.g., 2026) with no taxonomy available, **When** attempting to load, **Then** a clear error message indicates the year is not supported
3. **Given** an organization with submissions across multiple years, **When** viewing each submission, **Then** the correct taxonomy version is used for display and validation

---

### Edge Cases

- What happens when the gem fails to load at application boot?
- How does the system handle a submission with mixed data sources (some calculated, some manual, some from settings)?
- What happens when a gate field changes state after dependent fields have values?
- How does the system behave when XBRL generation fails mid-process?
- What happens when Arelle external validation is enabled but the service is unavailable?

## Requirements *(mandatory)*

### Functional Requirements

**Gem Integration**:
- **FR-001**: System MUST load the `amsf_survey` and `amsf_survey-real_estate` gems at application initialization
- **FR-002**: System MUST verify gem loading by logging the field count at startup
- **FR-003**: System MUST provide access to questionnaire via `AmsfSurvey.questionnaire(industry: :real_estate, year: year)`

**XBRL Generation**:
- **FR-004**: System MUST generate valid XBRL documents using `AmsfSurvey.to_xbrl(submission)`
- **FR-005**: System MUST produce XBRL output that passes Arelle validation
- **FR-006**: System MUST remove the existing ERB-based XBRL template (`app/views/submissions/show.xml.erb`)

**Validation**:
- **FR-007**: System MUST validate submissions using `AmsfSurvey.validate(submission)`
- **FR-008**: System MUST support optional external Arelle validation in addition to Ruby-native validation
- **FR-009**: System MUST display validation errors in French by default, with English as a configurable option

**Data Flow**:
- **FR-010**: System MUST merge data from three sources: calculated values, settings-based values, and manual overrides
- **FR-011**: System MUST persist values in `SubmissionValue` model for audit trail
- **FR-012**: System MUST track the source of each value (calculated, from_settings, manual)

**Questionnaire Access**:
- **FR-013**: System MUST retrieve field metadata (label, type, section) from the gem
- **FR-014**: System MUST support field access by semantic name (e.g., `:total_clients`) or XBRL code (e.g., `"a1101"`)
- **FR-015**: System MUST implement gate field visibility logic using `field.visible?(data)`

**Code Cleanup**:
- **FR-016**: System MUST remove obsolete taxonomy parsing code (`Xbrl::Taxonomy`, `Xbrl::TaxonomyElement`, `Xbrl::Survey`)
- **FR-017**: System MUST remove embedded taxonomy files (`docs/taxonomy/`, `config/xbrl_short_labels.yml`)
- **FR-018**: System MUST retain and adapt CRM-specific calculation logic (`Xbrl::ElementDefinitions`)

### Key Entities

- **Questionnaire**: The gem's representation of the AMSF survey structure, containing sections and fields with metadata
- **Field**: A single survey element with properties: id, label, type, section, gate status, visibility rules
- **Submission (Gem)**: A value object representing survey data for generation/validation (not persisted)
- **Submission (ActiveRecord)**: The persisted model tracking submission lifecycle and organization relationship
- **SubmissionValue**: Stored field values with source tracking for audit purposes
- **Section**: Logical grouping of related fields within the questionnaire

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: XBRL documents generated by the gem pass 100% of Arelle validation rules that current implementation passes
- **SC-002**: All 600+ survey fields are accessible through the gem with correct French labels
- **SC-003**: Survey questionnaire loads and displays within 2 seconds for users
- **SC-004**: Validation feedback is provided to users within 5 seconds for typical submissions
- **SC-005**: Migration reduces taxonomy-related code in immo_crm by at least 400 lines (removing ~500 lines of parsing code)
- **SC-006**: Zero data loss during migration - all existing submission values remain accessible
- **SC-007**: 100% of existing integration tests pass after migration (comparison tests between old and new output)

## Assumptions

- The `amsf_survey` gem (version supporting 2025 taxonomy) is available and stable
- The gem's semantic field names map correctly to existing XBRL codes used in CRM calculations
- External Arelle validation service remains available for authoritative checks
- Existing CRM data model (clients, transactions, mandates, settings) does not require changes
- The 105 control elements in Settings model map directly to gem field names

## Out of Scope

- Changes to CRM data entry workflows
- New calculation formulas (only adapting existing ones to use gem field names)
- Multi-language support beyond French/English for validation messages
- Support for taxonomy years prior to 2025
- Changes to external Arelle validation infrastructure
